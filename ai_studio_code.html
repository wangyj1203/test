<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>少年水浒 - Q版火柴人演示</title>
    <style>
        body {
            background-color: #121212;
            color: white;
            font-family: 'Microsoft YaHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        #game-stage {
            width: 375px;
            height: 680px;
            background: linear-gradient(to bottom, #2c3e50, #1a252f);
            border: 4px solid #333;
            border-radius: 20px;
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.9);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 背景纹理 */
        .bg-pattern {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: radial-gradient(#ffffff 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.05;
            z-index: 0;
        }

        .header {
            height: 45px; background: rgba(0,0,0,0.4);
            display: flex; justify-content: center; align-items: center; z-index: 10;
            font-size: 14px; color: #aaa; border-bottom: 1px solid #444;
            backdrop-filter: blur(5px);
        }

        .battle-area {
            flex: 1; position: relative; z-index: 1; padding: 20px 15px;
            display: flex; flex-direction: column; justify-content: space-around; /* 稍微拉开上下距离 */
        }

        .team-row {
            display: flex; justify-content: space-around; height: 120px; align-items: flex-end; /* 底部对齐 */
        }

        /* 角色容器 - 尺寸缩小 */
        .hero-unit {
            width: 70px; 
            height: 100px; /* 容器变矮，名字就不会飞很高 */
            position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1);
            transform-origin: center bottom;
        }

        /* 呼吸动画更轻柔 */
        .hero-unit.idle canvas { animation: breathe 2s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { transform: scaleY(1) translateY(0); } 50% { transform: scaleY(0.98) translateY(1px); } }

        canvas { 
            filter: drop-shadow(0px 2px 3px rgba(0,0,0,0.3)); 
            margin-bottom: -5px; /* 稍微下沉一点 */
        }

        /* 名字紧贴头部 */
        .name-tag { 
            font-size: 11px; 
            margin-bottom: -2px; 
            color: #ddd;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 5;
            background: rgba(0,0,0,0.3);
            padding: 1px 4px;
            border-radius: 4px;
        }

        /* 状态条紧凑化 */
        .stats { width: 90%; height: 4px; background: #222; margin-top: 2px; border-radius: 2px; overflow: hidden;}
        .hp-bar { height: 100%; background: #e74c3c; width: 100%; transition: width 0.3s; border-radius: 2px; }
        .rage-dots { display: flex; justify-content: center; margin-top: 2px; gap: 2px; }
        .dot { width: 4px; height: 4px; background: #444; border-radius: 50%; }
        .dot.full { background: #f1c40f; box-shadow: 0 0 3px gold; }

        /* 伤害数字优化 */
        .dmg-text {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            font-size: 20px; font-weight: 800; color: #fff;
            text-shadow: 0 0 5px #c0392b;
            opacity: 0; pointer-events: none; z-index: 200;
        }
        .dmg-anim { animation: floatUp 0.6s forwards ease-out; }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateX(-50%) scale(0.8); }
            50% { transform: translateX(-50%) scale(1.2); }
            100% { opacity: 0; top: -40px; transform: translateX(-50%) scale(1); }
        }

        /* 刀光微调 */
        .slash-fx {
            position: absolute; width: 80px; height: 80px;
            top: 20px; left: -5px; opacity: 0; z-index: 150; pointer-events: none;
            border: 2px solid rgba(255,255,255,0.9); border-radius: 50%;
        }
        .slash-anim { animation: slash 0.2s; }
        @keyframes slash {
            0% { opacity: 1; transform: scale(0.5) rotate(45deg); border-width: 6px; }
            100% { opacity: 0; transform: scale(1.4) rotate(135deg); border-width: 0px; }
        }

        /* 合击遮罩 */
        #mask {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.85); z-index: 300; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .ult-text { font-size: 36px; font-weight: bold; color: gold; letter-spacing: 5px; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0); opacity:0; } to { transform: scale(1); opacity:1; } }

        /* 控制区 */
        .controls { height: 100px; background: #161616; padding: 10px; display: flex; flex-direction: column; z-index: 20; border-top: 1px solid #333;}
        #log { flex: 1; font-size: 11px; color: #777; overflow-y: auto; margin-bottom: 8px; font-family: monospace; }
        button { 
            background: linear-gradient(to right, #c0392b, #d35400); 
            color: white; border: none; padding: 10px; border-radius: 20px; 
            font-size: 14px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(192, 57, 43, 0.3);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        button:disabled { background: #444; box-shadow: none; color: #888; }

    </style>
</head>
<body>

<div id="game-stage">
    <div class="bg-pattern"></div>
    <div class="header">少年水浒 - Q版战斗演示 v4.0</div>

    <div class="battle-area">
        <!-- 敌方 (Top) -->
        <div class="team-row" id="enemy-row"></div>
        <!-- 我方 (Bottom) -->
        <div class="team-row" id="player-row"></div>
    </div>

    <!-- 合击层 -->
    <div id="mask">
        <div class="ult-text" id="ult-msg">合击!</div>
        <div style="color:#aaa; font-size:12px; margin-top:10px;">双人羁绊触发</div>
    </div>

    <div class="controls">
        <div id="log">准备就绪...</div>
        <button id="btn-start" onclick="battleStart()">开始战斗</button>
    </div>
</div>

<script>
    // --- 绘图引擎 (Q版调整) ---
    const drawEngine = {
        draw: (canvas, type, color) => {
            const ctx = canvas.getContext('2d');
            const w = canvas.width; const h = canvas.height;
            ctx.clearRect(0, 0, w, h);
            
            // 线条柔和设置
            ctx.lineWidth = 2.5; // 线条变细一点
            ctx.lineCap = 'round'; 
            ctx.lineJoin = 'round';
            ctx.strokeStyle = color; 
            ctx.fillStyle = color;

            const cx = w / 2;
            const headY = 22; // 头部位置下移
            const headR = 10; // 头变小
            const bodyTop = headY + headR;
            const bodyBottom = bodyTop + 25; // 身体变短 (Q版比例)
            const legBottom = bodyBottom + 20;

            // 头
            ctx.beginPath(); ctx.arc(cx, headY, headR, 0, Math.PI*2); ctx.fill();
            // 身
            ctx.beginPath(); ctx.moveTo(cx, bodyTop); ctx.lineTo(cx, bodyBottom); ctx.stroke();
            // 腿 (稍微弯曲一点，显得自然)
            ctx.beginPath(); ctx.moveTo(cx, bodyBottom); ctx.quadraticCurveTo(cx-5, bodyBottom+10, cx-12, legBottom); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(cx, bodyBottom); ctx.quadraticCurveTo(cx+5, bodyBottom+10, cx+12, legBottom); ctx.stroke();
            
            drawEngine.drawWeapon(ctx, type, cx, bodyTop + 5); // 手臂位置
        },
        drawWeapon: (ctx, type, cx, shoulderY) => {
            if (type === 'wusong') {
                // 双刀 - 手臂向前
                ctx.strokeStyle = '#fff';
                ctx.beginPath(); ctx.moveTo(cx, shoulderY); ctx.lineTo(cx-15, shoulderY+12); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx, shoulderY); ctx.lineTo(cx+15, shoulderY+12); ctx.stroke(); 
                // 武器 - 变小
                ctx.lineWidth=2; ctx.strokeStyle='#5dade2'; 
                ctx.beginPath(); ctx.moveTo(cx-15, shoulderY+12); ctx.lineTo(cx-20, shoulderY-8); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx+15, shoulderY+12); ctx.lineTo(cx+20, shoulderY-8); ctx.stroke();
            } else if (type === 'luzhishen') {
                // 禅杖 - 扛在肩上
                ctx.strokeStyle = '#f39c12';
                ctx.beginPath(); ctx.moveTo(cx, shoulderY); ctx.lineTo(cx+12, shoulderY-5); ctx.lineTo(cx-8, shoulderY+12); ctx.stroke();
                // 杆子
                ctx.lineWidth=3; ctx.strokeStyle='#555';
                ctx.beginPath(); ctx.moveTo(cx+18, shoulderY-20); ctx.lineTo(cx-5, shoulderY+25); ctx.stroke();
                // 铲头
                ctx.fillStyle='#f1c40f';
                ctx.beginPath(); ctx.arc(cx+18, shoulderY-20, 5, 0, Math.PI*2); ctx.fill();
            } else {
                // 敌人 - 简单的手
                ctx.strokeStyle = '#a569bd';
                ctx.beginPath(); ctx.moveTo(cx, shoulderY); ctx.lineTo(cx+12, shoulderY+8); ctx.stroke();
                // 扇子/小剑
                ctx.fillStyle = '#8e44ad';
                ctx.beginPath(); ctx.moveTo(cx+12, shoulderY+8); ctx.lineTo(cx+18, shoulderY); ctx.lineTo(cx+22, shoulderY+10); ctx.fill();
            }
        }
    };

    // --- 数据 (颜色调柔和) ---
    const HEROES = [
        { id: 1, name: '武松', type: 'wusong', color: '#5dade2', hp: 2000, maxHp: 2000, atk: 320, rage: 2, team: 'player', partner: 2 },
        { id: 2, name: '鲁智深', type: 'luzhishen', color: '#f39c12', hp: 2500, maxHp: 2500, atk: 180, rage: 1, team: 'player' },
        { id: 3, name: '李逵', type: 'wusong', color: '#e74c3c', hp: 1800, maxHp: 1800, atk: 350, rage: 1, team: 'player' }, 
        { id: 11, name: '西门庆', type: 'enemy', color: '#a569bd', hp: 2200, maxHp: 2200, atk: 250, rage: 0, team: 'enemy' },
        { id: 12, name: '潘金莲', type: 'enemy', color: '#d98880', hp: 1600, maxHp: 1600, atk: 220, rage: 0, team: 'enemy' },
        { id: 13, name: '蒋门神', type: 'enemy', color: '#7f8c8d', hp: 2100, maxHp: 2100, atk: 200, rage: 0, team: 'enemy' }
    ];

    function init() {
        renderTeam('enemy-row', HEROES.filter(h => h.team === 'enemy'));
        renderTeam('player-row', HEROES.filter(h => h.team === 'player'));
    }

    function renderTeam(containerId, list) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        list.forEach(h => {
            const div = document.createElement('div');
            div.className = 'hero-unit idle'; div.id = `hero-${h.id}`;
            // 结构调整：名字在Canvas上方，但是通过CSS margin-bottom拉近
            div.innerHTML = `
                <div class="name-tag" style="border-left: 3px solid ${h.color}">${h.name}</div>
                <div class="slash-fx"></div>
                <div class="dmg-text"></div>
                <canvas width="70" height="90"></canvas>
                <div class="stats">
                    <div class="hp-bar" id="hp-${h.id}"></div>
                </div>
                <div class="rage-dots" id="rage-${h.id}">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
            `;
            container.appendChild(div);
            drawEngine.draw(div.querySelector('canvas'), h.type, h.color);
            updateStats(h);
        });
    }

    function updateStats(hero) {
        if(hero.hp<0) hero.hp=0;
        document.getElementById(`hp-${hero.id}`).style.width = (hero.hp/hero.maxHp*100)+'%';
        const dots = document.getElementById(`rage-${hero.id}`).querySelectorAll('.dot');
        dots.forEach((d,i) => d.className = i<hero.rage ? 'dot full':'dot');
    }

    // --- 移动与战斗逻辑 ---

    function calculateMove(attackerId, targetId) {
        const aElem = document.getElementById(`hero-${attackerId}`);
        const tElem = document.getElementById(`hero-${targetId}`);
        const aRect = aElem.getBoundingClientRect();
        const tRect = tElem.getBoundingClientRect();

        const tX = tRect.left + tRect.width / 2;
        const tY = tRect.top + tRect.height / 2;
        const aX = aRect.left + aRect.width / 2;
        const aY = aRect.top + aRect.height / 2;

        let moveX = tX - aX;
        let moveY = tY - aY;

        // 停止距离变小 (Q版更贴近)
        const stopDistance = 60; 
        const isPlayer = HEROES.find(h=>h.id===attackerId).team === 'player';
        
        if (isPlayer) moveY += stopDistance;
        else moveY -= stopDistance;

        // 随机左右偏移减少
        moveX += (Math.random() - 0.5) * 10; 

        return `translate(${moveX}px, ${moveY}px) scale(1.1)`; // 放大倍率也减小
    }

    async function battleStart() {
        document.getElementById('btn-start').disabled = true;
        let turn = 1;
        while(true) {
            if(!HEROES.some(h=>h.team==='player' && h.hp>0) || !HEROES.some(h=>h.team==='enemy' && h.hp>0)) {
                log("战斗结束"); break;
            }
            log(`--- 第 ${turn} 回合 ---`);
            const actors = HEROES.filter(h=>h.hp>0).sort((a,b)=>a.id-b.id);
            for(let hero of actors) {
                if(hero.hp<=0) continue;
                const enemies = HEROES.filter(h=>h.team !== hero.team && h.hp > 0);
                if(enemies.length === 0) break;
                await performAction(hero, enemies[0]);
            }
            turn++;
            await sleep(600);
        }
    }

    async function performAction(hero, target) {
        const dom = document.getElementById(`hero-${hero.id}`);
        const isSkill = hero.rage >= 4;
        
        // 合击判断
        if (hero.name === '武松' && isSkill) {
            const partner = HEROES.find(h=>h.id === hero.partner);
            if(partner && partner.hp>0) {
                await performCombo(hero, partner, HEROES.filter(h=>h.team!==hero.team && h.hp>0));
                return;
            }
        }

        // 动作
        dom.classList.remove('idle');
        dom.style.zIndex = 100;
        dom.style.transform = calculateMove(hero.id, target.id);
        
        await sleep(300); 

        // 伤害
        const tDom = document.getElementById(`hero-${target.id}`);
        tDom.querySelector('.slash-fx').classList.add('slash-anim');
        
        const dmg = Math.floor(hero.atk * (isSkill?1.5:1.0));
        target.hp -= dmg;
        
        // 反馈
        tDom.style.transform = 'translateX(2px)'; // 轻微震动
        setTimeout(()=>tDom.style.transform='translateX(0)', 100);
        
        const txt = tDom.querySelector('.dmg-text');
        txt.innerText = dmg;
        txt.classList.add('dmg-anim');
        
        updateStats(target);
        if(target.hp<=0) { tDom.classList.add('dead'); dom.classList.add('dead'); /* 这里是把攻击者设为dead的bug修复 */ dom.classList.remove('dead'); tDom.style.opacity = 0.5; }
        log(`${hero.name} > ${target.name} : -${dmg}`);

        await sleep(300);

        // 归位
        dom.style.transform = 'translate(0,0) scale(1)';
        tDom.querySelector('.slash-fx').classList.remove('slash-anim');
        txt.classList.remove('dmg-anim');

        await sleep(300);
        dom.style.zIndex = ''; 
        dom.classList.add('idle');

        if(isSkill) hero.rage = 0;
        else hero.rage = Math.min(4, hero.rage+2);
        updateStats(hero);
    }

    async function performCombo(h1, h2, enemies) {
        log(`[合击] ${h1.name} & ${h2.name}`);
        const d1 = document.getElementById(`hero-${h1.id}`);
        const d2 = document.getElementById(`hero-${h2.id}`);
        
        d1.style.zIndex=200; d2.style.zIndex=200;
        d1.classList.remove('idle'); d2.classList.remove('idle');
        
        // 合击位移
        d1.style.transform = 'translate(40px, -120px) scale(1.2)';
        d2.style.transform = 'translate(-40px, -120px) scale(1.2)';
        
        await sleep(400);
        
        const mask = document.getElementById('mask');
        mask.style.display = 'flex';
        document.getElementById('ult-msg').innerText = "佛挡杀佛!";
        await sleep(1200);
        mask.style.display = 'none';

        enemies.forEach(e => {
            e.hp -= Math.floor(h1.atk * 2.2);
            updateStats(e);
            const ed = document.getElementById(`hero-${e.id}`);
            const txt = ed.querySelector('.dmg-text');
            txt.innerText = "CRIT!";
            txt.style.color = "#f1c40f";
            txt.classList.add('dmg-anim');
            if(e.hp<=0) ed.style.opacity = 0.5;
            setTimeout(()=>txt.classList.remove('dmg-anim'), 600);
        });

        await sleep(600);
        d1.style.transform=''; d2.style.transform='';
        d1.classList.add('idle'); d2.classList.add('idle');
        d1.style.zIndex=''; d2.style.zIndex='';
        
        h1.rage=0; h2.rage= Math.max(0, h2.rage-1);
        updateStats(h1); updateStats(h2);
    }

    function sleep(ms) { return new Promise(r=>setTimeout(r,ms)); }
    function log(m) { const l=document.getElementById('log'); l.innerHTML+=`<div>${m}</div>`; l.scrollTop=l.scrollHeight; }

    init();
</script>
</body>
</html>